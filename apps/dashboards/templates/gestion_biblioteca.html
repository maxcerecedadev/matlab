{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Gestión de Biblioteca{% endblock title %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/datatables/datatables.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/datatables/datatables.js' %}"></script>
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Biblioteca</h5>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevoContenido">
          <i class="icon-base ri-add-line me-1"></i> Nuevo Contenido
        </button>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="icon-base ri-search-line"></i></span>
              <input type="text" class="form-control" id="searchInput" placeholder="Buscar contenido...">
            </div>
          </div>
          <div class="col-md-6">
            <select class="form-select" id="filterTipo">
              <option value="">Todos los tipos</option>
              <option value="Practica">Practica</option>
              <option value="Juego">Juego</option>
              <option value="Contenido">Contenido</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100">
              <i class="icon-base ri-filter-3-line me-1"></i> Filtrar
            </button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover" id="usersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for item in contenidos %}
              <tr>
                <td>{{ item.id }}</td>
                <td>{{ item.titulo }}</td>
                <td><span class="badge bg-label-info">{{ item.tipo }}</span></td>
                <td>{{ item.descripcion|truncatechars:50 }}</td>
                <td>
                  {% if item.activo %}
                    <span class="badge bg-success">Activo</span>
                  {% else %}
                    <span class="badge bg-secondary">Inactivo</span>
                  {% endif %}
                </td>
                <td class="text-center">
                       <div class="d-flex justify-content-center">
    <button type="button" 
            class="btn btn-icon btn-outline-primary me-2" 
            data-bs-toggle="modal" 
            data-bs-target="#editContenidoModal" 
            data-contenido-id="{{ item.id }}"
            data-titulo="{{ item.titulo }}"
            data-tipo="{{ item.tipo }}"
            data-descripcion="{{ item.descripcion }}"
            data-activo="{{ item.activo|yesno:'1,0' }}"
            title="Editar contenido">
                      <i class="menu-icon icon-base ri ri-edit-line"></i>
    </button>
    <button type="button" 
            class="btn btn-icon btn-outline-danger" 
            data-bs-toggle="modal" 
            data-bs-target="#deleteContenidoModal" 
            data-contenido-id="{{ item.id }}"
            data-titulo="{{ item.titulo }}"
            title="Eliminar contenido">
            <i class="menu-icon icon-base ri ri-delete-bin-line"></i>
    </button>
</div>
                </td>
              </tr>
              {% endfor %}
              <!-- More book rows can be added here -->
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="d-flex justify-content-between mt-4">
          <div class="text-muted">
            Mostrando <span class="fw-semibold">1</span> a <span class="fw-semibold">10</span> de <span class="fw-semibold">24</span> libros
          </div>
          <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
              <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1">Anterior</a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#">Siguiente</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Nuevo Libro -->
<div class="modal fade" id="nuevoContenido" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar Nuevo Contenido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formNuevoContenido" method="post" action="{% url 'biblioteca:crear_contenido' %}">
          {% csrf_token %}
          <div class="row">
            <div class="col-12">
              <div class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">Título</label>
                  <input type="text" name="titulo" class="form-control" placeholder="Ej: Introducción a Python" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tipo</label>
                  <select name="tipo" class="form-select" required>
                    <option value="">Seleccionar tipo</option>
                    <option value="Practica">Práctica</option>
                    <option value="Juego">Juego</option> 
                    <option value="Contenido">Contenido</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Estado</label>
                  <select name="activo" class="form-select">
                    <option value="1">Activo</option>
                    <option value="0">Inactivo</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Descripción</label>
                  <textarea name="descripcion" class="form-control" rows="4" placeholder="Descripción detallada del contenido" required></textarea>
                </div>
              </div>
            </div>
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="submit" form="formNuevoContenido" class="btn btn-primary">
          <i class="icon-base ri-save-line me-1"></i> Guardar Contenido
        </button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Editar Contenido -->
<div class="modal fade" id="editContenidoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Contenido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editContenidoForm" method="post" action="{% url 'editar_biblioteca' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="edit_contenido_id"> 
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_titulo" class="form-label">Título</label>
            <input type="text" class="form-control" id="edit_titulo" name="titulo" required>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="edit_tipo" class="form-label">Tipo</label>
                <select class="form-select" id="edit_tipo" name="tipo" required>
                  <option value="Practica">Practica</option>
                  <option value="Juego">Juego</option>
                  <option value="Contenido">Contenido</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label d-block">Estado</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="activo" id="edit_activo_si" value="1" checked>
                  <label class="form-check-label" for="edit_activo_si">Activo</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="activo" id="edit_activo_no" value="0">
                  <label class="form-check-label" for="edit_activo_no">Inactivo</label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit_descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="edit_descripcion" name="descripcion" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar Contenido -->
<div class="modal fade" id="deleteContenidoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="deleteContenidoForm" method="post" action="{% url 'eliminar_biblioteca' %}">
        {% csrf_token %}
        <input type="hidden" name="id" id="delete_contenido_id">
        <div class="modal-body">
          <p>¿Está seguro que desea eliminar el contenido <strong id="delete_contenido_titulo"></strong>?</p>
          <p class="text-danger">Esta acción no se puede deshacer.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block page_js %}
<script>
   // Inicializar DataTable con configuración personalizada
  $(document).ready(function() {
    const table = $('#usersTable').DataTable({
      responsive: true,
      ordering: true,
      order: [[0, 'desc']],
      dom: '<"d-flex justify-content-between align-items-center mb-3"f<"ms-2"l>>rt<"d-flex justify-content-between align-items-center"ip>',
      language: {
        search: "",
        searchPlaceholder: "Buscar...",
        lengthMenu: "Mostrar _MENU_ registros",
        info: "Mostrando _START_ a _END_ de _TOTAL_ usuarios",
        paginate: {
          previous: "<i class='icon-base ri-arrow-left-s-line'></i>",
          next: "<i class='icon-base ri-arrow-right-s-line'></i>"
        }
      }
    });

    // Inicializar Select2
    $('.select2').select2({
      placeholder: 'Seleccionar',
      width: '100%',
      theme: 'bootstrap-5'
    });
  });
 
  

  // Función auxiliar para obtener el token CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Handle edit user modal
  $('#editContenidoModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    const contenidoId = button.data('contenido-id');
    const titulo = button.data('titulo');
    const tipo = button.data('tipo');
    const descripcion = button.data('descripcion');
    const activo = button.data('activo') === '1';
    
    const modal = $(this);
    modal.find('#edit_contenido_id').val(contenidoId); 
    modal.find('#edit_titulo').val(titulo);
    modal.find('#edit_tipo').val(tipo);
    modal.find('#edit_descripcion').val(descripcion);
    modal.find('#edit_activo').prop('checked', activo);
  });

  // Handle delete user modal
  $('#deleteContenidoModal').on('show.bs.modal', function (event) {
    const button = $(event.relatedTarget);
    const contenidoId = button.data('contenido-id');
    const titulo = button.data('titulo');
    
    const modal = $(this);
    modal.find('#delete_contenido_id').val(contenidoId);
    modal.find('#delete_contenido_titulo').text(titulo);
  });

  // Handle new content form submission
  $('#formNuevoContenido').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    
    $.ajax({
      type: 'POST',
      url: $(this).attr('action'),
      data: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      },
      success: function(response) {
        if (response.success) {
          $('#nuevoContenido').modal('hide');
          // Show success message
          if (response.message) {
            const alert = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            $('.content-wrapper').prepend(alert);
          }
          // Reload the page to see changes
          setTimeout(() => location.reload(), 1500);
        } else {
          alert('Error al crear el contenido: ' + (response.message || 'Error desconocido'));
        }
      },
      error: function(xhr) {
        let errorMsg = 'Error de conexión. Por favor intente nuevamente.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMsg = xhr.responseJSON.message;
        }
        alert('Error: ' + errorMsg);
      }
    });
  });

  // Handle edit form submission
  $('#editContenidoForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    
    $.ajax({
      type: 'POST',
      url: $(this).attr('action'),
      data: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': getCookie('csrftoken')
      },
      success: function(response) {
        if (response.success) {
          $('#editContenidoModal').modal('hide');
          // Show success message
          if (response.message) {
            const alert = `
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${response.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            $('.content-wrapper').prepend(alert);
          }
          // Reload the page to see changes
          setTimeout(() => location.reload(), 1500);
        } else {
          alert('Error al actualizar el contenido: ' + (response.message || 'Error desconocido'));
        }
      },
      error: function(xhr) {
        let errorMsg = 'Error de conexión. Por favor intente nuevamente.';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          errorMsg = xhr.responseJSON.message;
        }
        alert('Error: ' + errorMsg);
      }
    });
  });

  // Handle delete form submission
  $('#deleteContenidoForm').on('submit', function(e) {
    e.preventDefault();
    if (!confirm('¿Está seguro que desea eliminar este contenido? Esta acción no se puede deshacer.')) {
      return false;
    }
    
    const formData = $(this).serialize();
    
    $.ajax({
      type: 'POST',
      url: $(this).attr('action'),
      data: formData,
      success: function(response) {
        if (response.success) {
          $('#deleteContenidoModal').modal('hide');
          // Reload the page to see changes
          location.reload();
        } else {
          alert('Error al eliminar el contenido: ' + (response.error || 'Error desconocido'));
        }
      },
      error: function() {
        alert('Error de conexión. Por favor intente nuevamente.');
      }
    });
  });

  // Handle filter form submission
  $('#filtroForm').on('submit', function(e) {
    e.preventDefault();
    const formData = $(this).serialize();
    window.location.href = '?' + formData;
  });
</script>
{% endblock %}
