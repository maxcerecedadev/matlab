<div class="col-12 mision-card" data-mision-id="{{ mision.mision_id }}" data-bloqueada="{% if mision.bloqueada %}true{% else %}false{% endif %}" data-operacion="{{ mision.tipo_operacion|lower }}" {% if not show_mission %}style="display: none;"{% endif %}>
    <div class="card h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div class="d-flex align-items-center">
                    <div>
                        <h5 class="mb-0">{{ mision.titulo }} {% if mision.tipo_operacion %}<span class="badge bg-label-primary ms-2 text-uppercase">
                            {% if mision.tipo_operacion == 'suma' %}
                            <i class="ri-add-line me-1"></i>
                            {% elif mision.tipo_operacion == 'resta' %}
                            <i class="ri-subtract-line me-1"></i>
                            {% elif mision.tipo_operacion == 'multiplicacion' %}
                            <i class="ri-close-line me-1"></i>
                            {% elif mision.tipo_operacion == 'division' %}
                            <i class="ri-divide-line me-1"></i>
                            {% endif %}
                            {{ mision.tipo_operacion }}</span>{% endif %}</h5>
                        <small class="text-muted">#MIS-{{ mision.mision_id|stringformat:"03d" }}</small>
                    </div>
                </div>
                <div class="dropdown">
                    <button type="button" class="btn p-0" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="ti ti-dots-vertical"></i>
                    </button>
                    <ul>
                        <li>
                            {% if user.rol.tipo != 'Profesor' and mision.bloqueada %}
                            <span class="dropdown-item text-muted d-flex align-items-center py-2 px-3 rounded-2 border-0">
                                
                                <div class="bg-secondary-subtle rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="ti ti-lock text-secondary"></i>
                                </div>
                                Bloqueada. Para desbloquear esta misión, debe ver al menos un contenido de la operación basica correspondiente. 
                                <br>
                                Puede encontrar dicho contenido en el módulo de biblioteca
                            </span>
                            {% else %}
                            <a class="dropdown-item aceptar-mision text-success fw-semibold d-flex align-items-center py-2 px-3 rounded-2 border-0 transition-all"
                               href="#"
                               data-bs-toggle="modal"
                               data-bs-target="#misionDetalleModal"
                               data-mision-id="{{ mision.mision_id }}"
                               data-mision-titulo="{{ mision.titulo }}">
                                <div class="bg-success-subtle rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                    <i class="ti ti-{% if user.rol.tipo == 'Profesor' %}eye{% else %}check{% endif %} text-success"></i>
                                </div>
                                {% if mision.estado_actual == 'en_progreso' %}
                                    Continuar misión
                                {% elif mision.estado_actual == 'completado' %}
                                    Ver misión
                                {% else %}
                                    {% if user.rol.tipo == 'Profesor' %}Revisar misión{% else %}Aceptar misión{% endif %}
                                {% endif %}
                            </a>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
            
            <p class="mb-3">{{ mision.descripcion|default:"Sin descripción" }}</p>
            </div>
            
            <div class="d-flex justify-content-between align-items-center" id="status-container-{{ mision.mision_id }}" {% if user.rol.tipo == 'Profesor' %}style="display:none;"{% endif %}>
                {% if user.rol.tipo != 'Profesor' %}
                <div class="d-flex align-items-center">
                    <span id="status-badge-{{ mision.mision_id }}" class="badge 
                        {% if mision.bloqueada %}bg-label-secondary
                        {% elif mision.estado_actual == 'completado' %}bg-label-success
                        {% elif mision.estado_actual == 'en_progreso' %}bg-label-info
                        {% elif mision.estado_actual == 'rechazado' %}bg-label-danger
                        {% else %}bg-label-warning
                        {% endif %} me-2">
                        {% if mision.bloqueada %}Bloqueada
                        {% elif mision.estado_actual == 'completado' %}Completada
                        {% elif mision.estado_actual == 'en_progreso' %}En progreso
                        {% elif mision.estado_actual == 'rechazado' %}Incorrecto
                        {% else %}Pendiente
                        {% endif %}
                    </span> 
                </div> 
                {% endif %}
            </div>
            <hr class="my-3">
            <div id="polya-container-{{ mision.mision_id }}" {% if user.rol.tipo == 'Profesor' %}style="display:none;"{% endif %} {% if mision.bloqueada and user.rol.tipo != 'Profesor' %}style="position: relative;"{% endif %}>
            <div class="mb-2 d-flex align-items-center">
                <i class="ri-brain-line text-primary me-2"></i>
                <h6 class="mb-0">Método de Pólya</h6>
            </div>
            {% if mision.bloqueada and user.rol.tipo != 'Profesor' %}
            <div class="alert alert-secondary mb-2">
              Esta misión está bloqueada. Ve a <strong>Biblioteca</strong> y confirma el contenido correspondiente para habilitar el método de Pólya.
            </div>
            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: rgba(255,255,255,0.6); z-index: 3;"></div>
            {% endif %}
            <div class="progress mb-3" style="height: 8px;">
                <div id="progress-bar-{{ mision.mision_id }}" class="progress-bar bg-success" role="progressbar"
                     style="width: {% if mision.estado_actual == 'completado' %}100{% elif mision.estado_actual == 'en_progreso' %}60{% elif mision.estado_actual == 'rechazado' %}25{% else %}10{% endif %}%"
                     aria-valuenow="{% if mision.estado_actual == 'completado' %}100{% elif mision.estado_actual == 'en_progreso' %}60{% elif mision.estado_actual == 'rechazado' %}25{% else %}10{% endif %}"
                     aria-valuemin="0" aria-valuemax="100"></div>
            </div>
                <div class="d-flex justify-content-end mb-2">
                {% if user.rol.tipo != 'Profesor' %}
                <button type="button" class="btn btn-sm btn-primary" id="btn-polya-save-{{ mision.mision_id }}">
                    <i class="ti ti-device-floppy me-1"></i> Guardar Pólya (1–4)
                </button>
                {% endif %}
                </div>
            <div class="accordion accordion-flush" id="polyaAccordion-{{ mision.mision_id }}">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="polyaHeading1-{{ mision.mision_id }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#polyaStep1-{{ mision.mision_id }}" aria-expanded="true"
                                aria-controls="polyaStep1-{{ mision.mision_id }}">
                            <span class="me-2 badge bg-label-primary">1</span> Comprender el problema
                        </button>
                    </h2>
                    <div id="polyaStep1-{{ mision.mision_id }}" class="accordion-collapse collapse show"
                         aria-labelledby="polyaHeading1-{{ mision.mision_id }}" data-bs-parent="#polyaAccordion-{{ mision.mision_id }}">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Descripción de la misión</label>
                                    <div class="alert alert-info py-2 px-3 mb-0">
                                        {{ mision.descripcion|default:"Sin descripción" }}
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Identificación de la operación</label>
                                    <select class="form-select" name="polya_identificacion_operacion_{{ mision.mision_id }}" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}>
                                        <option value="" selected>Selecciona una operación</option>
                                        <option value="suma">Suma</option>
                                        <option value="resta">Resta</option>
                                        <option value="multiplicacion">Multiplicación</option>
                                        <option value="division">División</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">¿Por qué esa operación?</label>
                                    <textarea class="form-control" rows="2" name="polya_por_que_operacion_{{ mision.mision_id }}" placeholder="Explica por qué elegiste esa operación" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}></textarea>
                                </div>
                                <div class="col-12">
                                <label class="form-label mb-1">Numeros de la operación</label>
                                    <small class="text-muted d-block mb-2">Agrega los números que intervienen en la operación (por ejemplo, 4 y 5 si es 4 + 5).</small>
                                    <div id="sumandos-container-{{ mision.mision_id }}"></div>
                                    {% if user.rol.tipo != 'Profesor' %}
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btn-add-sumando-{{ mision.mision_id }}">
                                        <i class="ti ti-plus me-1"></i> Agregar número
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="polyaHeading2-{{ mision.mision_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#polyaStep2-{{ mision.mision_id }}" aria-expanded="false"
                                aria-controls="polyaStep2-{{ mision.mision_id }}">
                            <span class="me-2 badge bg-label-info">2</span> Planificar la solución
                        </button>
                    </h2>
                    <div id="polyaStep2-{{ mision.mision_id }}" class="accordion-collapse collapse"
                         aria-labelledby="polyaHeading2-{{ mision.mision_id }}" data-bs-parent="#polyaAccordion-{{ mision.mision_id }}">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Estrategia principal</label>
                                    <textarea class="form-control" rows="3" name="polya_estrategia_{{ mision.mision_id }}" placeholder="Describe el plan general para resolver la misión" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="polyaHeading3-{{ mision.mision_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#polyaStep3-{{ mision.mision_id }}" aria-expanded="false"
                                aria-controls="polyaStep3-{{ mision.mision_id }}">
                            <span class="me-2 badge bg-label-warning">3</span> Ejecutar la operación
                        </button>
                    </h2>
                    <div id="polyaStep3-{{ mision.mision_id }}" class="accordion-collapse collapse"
                         aria-labelledby="polyaHeading3-{{ mision.mision_id }}" data-bs-parent="#polyaAccordion-{{ mision.mision_id }}">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Desarrollo</label>
                                    <textarea class="form-control" rows="4" name="polya_desarrollo_{{ mision.mision_id }}" placeholder="Escribe paso a paso cómo resuelves la misión" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label mb-1">Calculadora de práctica</label>
                                    <small class="text-muted d-block mb-2">Usa estos campos para practicar los cálculos.</small>
                                    <div class="row g-2 align-items-end">
                                        <div class="col-sm-8">
                                            <div id="polya-calc-inputs-{{ mision.mision_id }}">
                                                <input type="number" class="form-control mb-2" name="polya_calc_num_{{ mision.mision_id }}" placeholder="Número 1" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}>
                                                <input type="number" class="form-control mb-2" name="polya_calc_num_{{ mision.mision_id }}" placeholder="Número 2" {% if user.rol.tipo == 'Profesor' %}disabled readonly{% endif %}>
                                            </div>
                                            {% if user.rol.tipo != 'Profesor' %}
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-add-polya-calc-{{ mision.mision_id }}">
                                                <i class="ti ti-plus me-1"></i> Agregar número
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="col-sm-4">
                                            {% if user.rol.tipo != 'Profesor' %}
                                            <button type="button" class="btn btn-outline-secondary w-100 mb-2" id="btn-polya-calc-{{ mision.mision_id }}" data-operacion="{{ mision.tipo_operacion }}">
                                                <i class="ti ti-equal me-1"></i> Calcular resultado
                                            </button>
                                            {% endif %}
                                            <div class="small text-muted">Resultado: <span id="polya-calc-result-{{ mision.mision_id }}">—</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    {% if user.rol.tipo == 'Profesor' %}
                    <h2 class="accordion-header" id="polyaHeading4-{{ mision.mision_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#polyaStep4-{{ mision.mision_id }}" aria-expanded="false"
                                aria-controls="polyaStep4-{{ mision.mision_id }}">
                            <span class="me-2 badge bg-label-success">4</span> Verificar la respuesta
                        </button>
                    </h2>
                    <div id="polyaStep4-{{ mision.mision_id }}" class="accordion-collapse collapse"
                         aria-labelledby="polyaHeading4-{{ mision.mision_id }}" data-bs-parent="#polyaAccordion-{{ mision.mision_id }}">
                        <div class="accordion-body">
                            <div class="alert alert-secondary mb-3" id="polya-solucion-box-{{ mision.mision_id }}" style="display:none;">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="ti ti-user-check me-2"></i>
                                    <strong>Solución propuesta del estudiante seleccionado</strong>
                                </div>
                                <div id="polya-solucion-text-{{ mision.mision_id }}" class="bg-light rounded p-2"></div>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Revisión / verificación</label>
                                    <div class="form-control-plaintext small border rounded p-2 bg-light" id="polya-revision-text-{{ mision.mision_id }}"></div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Solución correcta de la misión</label>
                                    <div class="alert alert-success py-2 px-3 mb-0" id="polya-solucion-correcta-{{ mision.mision_id }}">—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <h2 class="accordion-header" id="polyaHeading4-{{ mision.mision_id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#polyaStep4-{{ mision.mision_id }}" aria-expanded="false"
                                aria-controls="polyaStep4-{{ mision.mision_id }}">
                            <span class="me-2 badge bg-label-success">4</span> Verificar y revisar
                        </button>
                    </h2>
                    <div id="polyaStep4-{{ mision.mision_id }}" class="accordion-collapse collapse"
                         aria-labelledby="polyaHeading4-{{ mision.mision_id }}" data-bs-parent="#polyaAccordion-{{ mision.mision_id }}">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Revisión / verificación</label>
                                    <textarea class="form-control form-control-sm" rows="2" name="polya_revision_verificacion_{{ mision.mision_id }}" placeholder="Comprueba si tu resultado tiene sentido"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Mi resultado</label>
                                    <input type="text" class="form-control form-control-sm" id="polya-mi-resultado-{{ mision.mision_id }}" placeholder="Escribe aquí tu resultado final">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Solución correcta de la misión</label>
                                    <div class="alert alert-success py-2 px-3 mb-0" id="polya-solucion-correcta-{{ mision.mision_id }}">—</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
(function(){
  var mid = {{ mision.mision_id }};
  var obtenerUrl = "{% url 'misiones:obtener_polya_um' mision.mision_id %}";
  var guardarUrl = "{% url 'misiones:guardar_polya_um' mision.mision_id %}";
  var esProfesor = {% if user.rol.tipo == 'Profesor' %}true{% else %}false{% endif %};
  var bloqueada = {% if mision.bloqueada %}true{% else %}false{% endif %};
  if (bloqueada && !esProfesor) {
    // Evita inicializar listeners/requests cuando la misión está bloqueada para el estudiante
    return;
  }
  var btn = document.getElementById('btn-polya-save-' + mid);
  function getByName(base){ return document.querySelector('[name="' + base + '_' + mid + '"]'); }
  var q = getByName('polya_que_se_pide');
  var d = getByName('polya_datos');
  var inc = getByName('polya_incognitas');
  var rep = getByName('polya_representacion');
  var est = getByName('polya_estrategia');
  var des = getByName('polya_desarrollo');
  var resInt = getByName('polya_resultados_intermedios');
  var tac1 = document.getElementById('tac1-' + mid);
  var tac2 = document.getElementById('tac2-' + mid);
  var tac3 = document.getElementById('tac3-' + mid);
  var tac4 = document.getElementById('tac4-' + mid);
  var rev = getByName('polya_revision_verificacion');
  var comp = getByName('polya_comprobacion_otro_metodo');
  var concl = getByName('polya_conclusion_final');
  var conf = getByName('polya_confianza');

  var identOp = getByName('polya_identificacion_operacion');
  var porQueOp = getByName('polya_por_que_operacion');
  var sumandosContainer = document.getElementById('sumandos-container-' + mid);
  var addSumandoBtn = document.getElementById('btn-add-sumando-' + mid);
  var solucionCorrectaBox = document.getElementById('polya-solucion-correcta-' + mid);
  var calcInputsContainer = document.getElementById('polya-calc-inputs-' + mid);
  var addCalcInputBtn = document.getElementById('btn-add-polya-calc-' + mid);
  var calcResult = document.getElementById('polya-calc-result-' + mid);
  var calcBtn = document.getElementById('btn-polya-calc-' + mid);

  function getSumandosFromInputs(){
    if (!sumandosContainer) return [];
    var inputs = sumandosContainer.querySelectorAll('input[name="polya_sumando_' + mid + '"]');
    var items = [];
    inputs.forEach(function(inp){
      var v = (inp.value || '').trim();
      if (v) items.push(v);
    });
    return items;
  }

  function renderSumandos(values){
    if (!sumandosContainer) return;
    sumandosContainer.innerHTML = '';
    var list = (Array.isArray(values) && values.length) ? values : [''];
    list.forEach(function(v){
      var group = document.createElement('div');
      group.className = 'mb-2';
      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.name = 'polya_sumando_' + mid;
      input.placeholder = 'Ingresa un número o sumando';
      input.value = v || '';
      group.appendChild(input);
      sumandosContainer.appendChild(group);
    });
  }

  if (addSumandoBtn && sumandosContainer){
    addSumandoBtn.addEventListener('click', function(){
      var actuales = getSumandosFromInputs();
      actuales.push('');
      renderSumandos(actuales);
    });
  }

  function getCalcNumbers(){
    if (!calcInputsContainer) return [];
    var inputs = calcInputsContainer.querySelectorAll('input[name="polya_calc_num_' + mid + '"]');
    var nums = [];
    inputs.forEach(function(inp){
      var v = parseFloat(inp.value);
      if (!isNaN(v)) nums.push(v);
    });
    return nums;
  }

  function addCalcInput(value){
    if (!calcInputsContainer || esProfesor) return;
    var input = document.createElement('input');
    input.type = 'number';
    input.className = 'form-control mb-2';
    input.name = 'polya_calc_num_' + mid;
    input.placeholder = 'Número';
    input.value = (value !== undefined && value !== null) ? value : '';
    calcInputsContainer.appendChild(input);
  }

  if (addCalcInputBtn && calcInputsContainer && !esProfesor){
    addCalcInputBtn.addEventListener('click', function(){
      addCalcInput('');
    });
  }

  if (calcBtn && calcInputsContainer && calcResult){
    calcBtn.addEventListener('click', function(){
      var nums = getCalcNumbers();
      if (nums.length < 2){
        calcResult.textContent = '—';
        return;
      }
      var op = (identOp && identOp.value) ? (identOp.value || '').toLowerCase() : ((calcBtn.getAttribute('data-operacion') || 'suma').toLowerCase());
      var r;
      switch(op){
        case 'suma':
          r = nums.reduce(function(acc, n){ return acc + n; }, 0);
          break;
        case 'resta':
          r = nums.slice(1).reduce(function(acc, n){ return acc - n; }, nums[0]);
          break;
        case 'multiplicacion':
          r = nums.reduce(function(acc, n){ return acc * n; }, 1);
          break;
        case 'division':
          r = nums[0];
          for (var i = 1; i < nums.length; i++){
            if (nums[i] === 0){
              calcResult.textContent = 'No permitido';
              return;
            }
            r = r / nums[i];
          }
          break;
        default:
          r = nums.reduce(function(acc, n){ return acc + n; }, 0);
      }
      calcResult.textContent = isNaN(r) ? '—' : r;
    });
  }

  function load(){
    try {
      fetch(obtenerUrl, { credentials: 'same-origin' })
        .then(function(r){ return r.json(); })
        .then(function(j){
          if (j && j.status === 'success' && j.data){
            var data = j.data;
            if (q) q.value = data.que_se_pide || '';
            if (d) d.value = data.datos_conocidos || '';
            if (inc) inc.value = data.incognitas || '';
            if (rep) rep.value = data.representacion || '';
            if (est) est.value = data.estrategia_principal || '';
            if (des) des.value = data.desarrollo || '';
            if (resInt) resInt.value = data.resultados_intermedios || '';
            if (tac1) tac1.checked = !!data.tactica_similar;
            if (tac2) tac2.checked = !!data.tactica_descomponer;
            if (tac3) tac3.checked = !!data.tactica_ecuaciones;
            if (tac4) tac4.checked = !!data.tactica_formula;
            if (rev) rev.value = data.revision_verificacion || '';
            if (comp) comp.value = data.comprobacion_otro_metodo || '';
            if (concl) concl.value = data.conclusion_final || '';
            if (conf) conf.value = (data.confianza !== null && data.confianza !== undefined) ? data.confianza : '';
            if (identOp) identOp.value = data.identificacion_operacion || '';
            if (porQueOp) porQueOp.value = data.por_que_esa_operacion || '';
            if (sumandosContainer) renderSumandos(data.sumandos || []);
            if (solucionCorrectaBox) solucionCorrectaBox.textContent = data.solucion_correcta || '—';
          }
        });
    } catch(e) {}
  }

  function save(){
    try {
      if (!btn) return;
      btn.disabled = true;
      var payload = {
        que_se_pide: q ? q.value : null,
        datos_conocidos: d ? d.value : null,
        incognitas: inc ? inc.value : null,
        representacion: rep ? rep.value : null,
        estrategia_principal: est ? est.value : null,
        tactica_similar: tac1 ? tac1.checked : false,
        tactica_descomponer: tac2 ? tac2.checked : false,
        tactica_ecuaciones: tac3 ? tac3.checked : false,
        tactica_formula: tac4 ? tac4.checked : false,
        desarrollo: des ? des.value : null,
        resultados_intermedios: resInt ? resInt.value : null,
        revision_verificacion: rev ? rev.value : null,
        comprobacion_otro_metodo: comp ? comp.value : null,
        conclusion_final: concl ? concl.value : null,
        confianza: conf && conf.value !== '' ? parseInt(conf.value, 10) : null,
        identificacion_operacion: identOp ? identOp.value : null,
        por_que_esa_operacion: porQueOp ? porQueOp.value : null,
        sumandos: getSumandosFromInputs()
      };
      fetch(guardarUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      })
      .then(function(r){ return r.json(); })
      .then(function(j){
        if (j && j.status === 'success'){
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-success');
          btn.innerHTML = '<i class="ti ti-check me-1"></i> Guardado';
          setTimeout(function(){
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.innerHTML = '<i class="ti ti-device-floppy me-1"></i> Guardar Pólya (1–4)';
          }, 1500);
        }
      })
      .finally(function(){ btn.disabled = false; });
    } catch(e) { if (btn) btn.disabled = false; }
  }

  if (btn) btn.addEventListener('click', save);
  load();
})();
</script>
